<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="TravelRequest">
	<!-- 의뢰글 목록 조회 -->
	<resultMap type="TravelRequest" id="requestResultSet">
		<id property="requestId" column="REQUEST_ID"/>
		<result property="requestTitle" column="REQUEST_TITLE"/>
		<result property="userName" column="USER_NAME"/>
		<result property="requestPrice" column="REQUEST_PRICE"/>
		<result property="trvCost" column="TRV_COST"/>
		<result property="endDate" column="END_DATE"/>
	</resultMap>
	
	<!-- 설계글 목록 조회 -->
	<resultMap type="TravelRequestPlan" id="planListResultSet">
		<id property="planId" column="PLAN_ID"/>
		<result property="planTitle" column="PLAN_TITLE"/>
		<result property="memberId" column="MEMBER_ID"/>
		<result property="userName" column="USER_NAME"/>
		<result property="planContent" column="PLAN_CONTENT"/>
		<result property="enrollDate" column="ENROLL_DATE"/>
	</resultMap>
	
	<!-- 의뢰글 상세 보기 -->
	<resultMap type="TravelRequest" id="requestDetailResultSet">
		<id property="requestId" column="REQUEST_ID"/>
		<result property="requestTitle" column="REQUEST_TITLE"/>
		<result property="requestContent" column="REQUEST_CONTENT" jdbcType="CLOB" javaType="java.lang.String"/>
		<result property="userName" column="USER_NAME"/>
		<result property="requestPrice" column="REQUEST_PRICE"/>
		<result property="trvCost" column="TRV_COST"/>
		<result property="endDate" column="END_DATE"/>
		<collection property="planList" javaType="java.util.ArrayList"
					resultMap="planListResultSet"/>
	</resultMap>
	<!-- 의뢰하기 -->
	<insert id="insertRequest" parameterType="TravelRequest">
		INSERT INTO TRV_REQUEST
		VALUES(TRV_REQUEST_SEQ.NEXTVAL, #{requestTitle}, #{requestContent},
			   #{endDate}, #{requestPrice}, #{memberId}, 'N', NULL, #{trvCost})
	</insert>
	
	<!-- 의뢰글 목록 수 -->
	<select id="selectListCount" resultType="_int">
		SELECT COUNT(*)
		FROM TRV_REQUEST
		WHERE CHOOSE_STATUS = 'N'
	</select>
	
	<!-- 의뢰글 조회 -->
	<select id="selectRequestList" resultMap="requestResultSet">
		SELECT TR.REQUEST_ID, TR.REQUEST_TITLE, M.USER_NAME, TR.REQUEST_PRICE, TR.TRV_COST, TR.END_DATE
		FROM TRV_REQUEST TR
		JOIN MEMBER M ON (TR.MEMBER_ID = M.MEMBER_ID)
		WHERE TR.CHOOSE_STATUS = 'N'
		ORDER BY TR.REQUEST_ID DESC
	</select>
	
	<!-- 의뢰글 상세보기 -->
	<select id="selectOneRequest" parameterType="_int" resultMap="requestDetailResultSet">
	   SELECT SUB.REQUEST_ID, SUB.REQUEST_TITLE, SUB.REQUEST_CONTENT,
             SUB.USER_NAME, SUB.MEMBER_ID, SUB.REQUEST_PRICE, SUB.TRV_COST, SUB.END_DATE,
             SUB.PLAN_TITLE, SUB.PLAN_CONTENT, SUB.ENROLL_DATE, M.USER_NAME
       FROM (SELECT M.USER_NAME, TR.REQUEST_ID, TR.REQUEST_TITLE, TR.REQUEST_CONTENT, 
             TR.MEMBER_ID, TR.REQUEST_PRICE, TR.TRV_COST, TR.END_DATE,
             TP.PLAN_TITLE, TP.PLAN_CONTENT, TP.ENROLL_DATE
             FROM MEMBER M
             RIGHT JOIN TRV_PLAN TP ON (TP.MEMBER_ID= M.MEMBER_ID)
             RIGHT JOIN PARTICIPATION P ON (TP.PLAN_ID = P.PLAN_ID)
             RIGHT JOIN TRV_REQUEST TR ON (TR.REQUEST_ID = P.REQUEST_ID)) SUB
       LEFT JOIN MEMBER M ON (SUB.MEMBER_ID = M.MEMBER_ID)
	   WHERE SUB.REQUEST_ID  = #{requestId}
	</select>
	
	<!-- 설계글 인서트 -->
	<insert id="insertRequestPlan" parameterType="TravelRequestPlan">
		INSERT INTO TRV_PLAN
		VALUES (TRV_PLAN_SEQ.NEXTVAL, #{planTitle}, #{memberId}, 
				NULL, NULL, #{planContent}, NULL, SYSDATE, #{roomCharge}, #{trafficCharge}, #{etcCharge})
	</insert>
	
	<!-- 설계글 일자 인서트 -->
	<insert id="insertRequestDay" parameterType="PlanDay">
		<selectKey keyProperty="planId" resultType="_int" order="BEFORE">
			SELECT TRV_PLAN_SEQ.CURRVAL FROM DUAL
		</selectKey>
		INSERT INTO PLAN_DAY
		VALUES (PLAN_DAY_SEQ.NEXTVAL, #{pDay}, #{pDayMemo}, #{openStatus}, #{planId})
	</insert>
	
	<!-- 설계글 각 장소 인서트 -->
	<insert id="insertRequestPlace" parameterType="PlanPlace">
		<selectKey keyProperty="PdayId" resultType="_int" order="BEFORE">
			SELECT PLAN_DAY_SEQ.CURRVAL FROM DUAL
		</selectKey>
		INSERT INTO PLAN_PLACE
		VALUES (PLAN_PLACE_SEQ.NEXTVAL, #{PplaceTitle}, #{PplaceAddress}, #{PplaceLat}, #{PplaceLng}, #{PdayId}, 1)
	</insert>
	
	<!-- 설계글 의뢰참여 인서트 -->
	<insert id="insertParticipation" parameterType="Participation">
		<selectKey keyProperty="planId" resultType="_int" order="BEFORE">
			SELECT TRV_PLAN_SEQ.CURRVAL FROM DUAL
		</selectKey>
		INSERT INTO PARTICIPATION
		VALUES (PARTICIPATION_SEQ.NEXTVAL, 'N', SYSDATE, NULL, #{requestId}, #{planId})
	</insert>
	
	<!-- 설계글 불러오기 목록 조회 -->
	<select id="selectRequestPlanList" parameterType="TravelRequestPlan" resultMap="planListResultSet">
		SELECT *
		FROM TRV_PLAN
		WHERE MEMBER_ID = #{memberId}
	</select>
</mapper>